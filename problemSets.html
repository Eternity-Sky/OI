<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>题单</title>
    <link rel="stylesheet" href="styles.css">
    <script src="problems.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <div class="container">
        <div id="problemSets">
            <!-- 题单内容 -->
        </div>
        <div id="adminPanel" style="display: none;">
            <button id="addProblemSetBtn" class="admin-btn">发布新题单</button>
        </div>
        <div class="footer">
            <a href="index.html" class="about-button">返回首页</a>
        </div>
    </div>

    <!-- 添加题单的模态框 -->
    <div id="addProblemSetModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>发布新题单</h2>
            <form id="addProblemSetForm">
                <div class="form-group">
                    <label for="setName">题单名称：</label>
                    <input type="text" id="setName" required>
                </div>
                <div class="form-group">
                    <label for="setDescription">描述：</label>
                    <textarea id="setDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label for="setDate">比赛日期：</label>
                    <input type="date" id="setDate" required>
                </div>
                <div class="form-group">
                    <label for="setTime">比赛时间：</label>
                    <input type="text" id="setTime" placeholder="HH:MM ~ HH:MM" required>
                </div>
                <div class="form-group">
                    <label for="problemIds">题目ID（用逗号分隔）：</label>
                    <input type="text" id="problemIds" placeholder="例如：32,33,34,35" required>
                </div>
                <button type="submit" class="submit-btn">发布题单</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否是管理员
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser === 'kkks403') {
                document.getElementById('adminPanel').style.display = 'block';
            }

            // 显示题单列表
            const problemSetsDiv = document.getElementById('problemSets');
            for (const [setName, setInfo] of Object.entries(problemSets)) {
                const setDiv = document.createElement('div');
                setDiv.className = 'problem-set';
                
                // 创建题单标题和描述
                setDiv.innerHTML = `
                    <h2>${setName}</h2>
                    <p class="set-description">${setInfo.description}</p>
                    <p class="set-time">比赛时间：${setInfo.date} ${setInfo.time}</p>
                `;

                // 创建题目列表
                const problemList = document.createElement('div');
                problemList.className = 'problem-list';
                
                setInfo.problems.forEach(problemId => {
                    const problem = problems.find(p => p.id === problemId);
                    if (problem) {
                        const problemDiv = document.createElement('div');
                        problemDiv.className = 'problem-item';
                        problemDiv.innerHTML = `
                            <a href="problem.html?id=${problem.id}">${problem.title}</a>
                            <span class="difficulty-${problem.difficulty.toLowerCase()}">${problem.difficulty}</span>
                        `;
                        problemList.appendChild(problemDiv);
                    }
                });

                setDiv.appendChild(problemList);

                // 添加详细信息
                if (setInfo.details) {
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'set-details';
                    detailsDiv.innerHTML = `
                        <h3>比赛详情</h3>
                        <p><strong>时间限制：</strong></p>
                        <ul>
                            ${Object.entries(setInfo.details.timeLimit).map(([name, limit]) => 
                                `<li>${name}: ${limit}</li>`
                            ).join('')}
                        </ul>
                        <p><strong>内存限制：</strong>${setInfo.details.memoryLimit}</p>
                        <p><strong>编译选项：</strong>${Object.entries(setInfo.details.compiler).map(([lang, opts]) => 
                            `${lang}: ${opts}`
                        ).join(', ')}</p>
                        <h4>注意事项：</h4>
                        <ul>
                            ${setInfo.details.notes.map(note => 
                                `<li>${note}</li>`
                            ).join('')}
                        </ul>
                    `;
                    setDiv.appendChild(detailsDiv);
                }

                problemSetsDiv.appendChild(setDiv);
            }

            // 添加题单的模态框功能
            const modal = document.getElementById('addProblemSetModal');
            const btn = document.getElementById('addProblemSetBtn');
            const span = document.getElementsByClassName('close')[0];

            btn.onclick = () => modal.style.display = 'block';
            span.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }

            // 处理表单提交
            document.getElementById('addProblemSetForm').onsubmit = (e) => {
                e.preventDefault();
                
                const setName = document.getElementById('setName').value;
                const description = document.getElementById('setDescription').value;
                const date = document.getElementById('setDate').value;
                const time = document.getElementById('setTime').value;
                const problemIds = document.getElementById('problemIds').value
                    .split(',')
                    .map(id => parseInt(id.trim()));

                // 添加新题单
                problemSets[setName] = {
                    description: description,
                    problems: problemIds,
                    date: date,
                    time: time,
                    details: {
                        timeLimit: {
                            poker: "1.0秒",
                            explore: "1.0秒",
                            sticks: "1.0秒",
                            chain: "2.0秒"
                        },
                        memoryLimit: "512 MiB",
                        compiler: {
                            "C++": "-O2 -std=c++14 -static"
                        },
                        notes: [
                            "文件名（程序名和输入输出文件名）必须使用英文小写",
                            "main 函数的返回值类型必须是 int，程序正常结束时的返回值必须是 0",
                            "提交的程序代码文件的放置位置请参考各省的具体要求",
                            "若无特殊说明，结果的比较方式为全文比较（过滤行末空格及文末回车）",
                            "选手提交的程序源文件必须不大于 100KB",
                            "程序可使用的栈空间内存限制与题目的内存限制一致"
                        ]
                    }
                };

                // 保存到 localStorage
                localStorage.setItem('problemSets', JSON.stringify(problemSets));

                // 刷新页面
                location.reload();
            };
        });
    </script>
</body>
</html> 