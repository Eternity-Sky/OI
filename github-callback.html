<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>GitHub 绑定</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="loading">处理 GitHub 绑定中...</div>
    </div>
    <script>
        // 从 URL 获取授权码
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        
        if (code) {
            // 使用授权码获取访问令牌
            fetch('https://github.com/login/oauth/access_token', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: 'Ov23lizlCDOmy2QtkeCZ',
                    code: code
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    // 使用访问令牌获取用户信息
                    return fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `Bearer ${data.access_token}`
                        }
                    });
                }
                throw new Error('获取访问令牌失败');
            })
            .then(response => response.json())
            .then(data => {
                const currentUser = localStorage.getItem('currentUser');
                const userData = JSON.parse(localStorage.getItem(currentUser));
                
                userData.githubId = data.id;
                userData.githubUsername = data.login;
                localStorage.setItem(currentUser, JSON.stringify(userData));
                
                window.opener.location.reload();
                window.close();
            })
            .catch(error => {
                alert('GitHub 绑定失败，请重试');
                window.close();
            });
        } else {
            alert('授权失败，请重试');
            window.close();
        }
    </script>
</body>
</html> 